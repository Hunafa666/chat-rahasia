<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>CHAT RAHASIA</title>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f0e4d7;
    }
    .container {
        width: 600px;
        margin: 40px auto;
        background: #b5896b;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 0 10px #00000055;
    }
    #messages {
        height: 380px;
        overflow-y: auto;
        background: #d1a888;
        padding: 10px;
        border-radius: 15px;
        border: 3px solid #8b5e3c;
    }
    .msg {
        background: white;
        padding: 8px 12px;
        margin-bottom: 10px;
        border-radius: 10px;
        max-width: 80%;
        animation: fade .3s;
    }
    .me { background: #dcf8c6; margin-left: auto; }
    @keyframes fade { from {opacity:0;} to {opacity:1;} }

    #input-area {
        display: flex;
        margin-top: 15px;
        gap: 10px;
    }
    #input {
        flex: 1;
        padding: 10px;
        border-radius: 10px;
        border: none;
    }

    button {
        padding: 10px 15px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
    }
    #sendBtn { background: #4CAF50; color: white; }
    #clearBtn { 
        background: #ff5252; 
        color: white; 
        margin-top: 10px; 
        width: 100%; 
    }

    .onlineBox {
        background:white; 
        padding:5px 10px; 
        border-radius:10px;
        margin-bottom:10px;
        text-align:right;
    }
</style>

</head>
<body>

<h1 style="text-align:center; margin-top:20px;">CHAT RAHASIA</h1>

<div class="container">

    <div class="onlineBox">Online: <span id="onlineCount">0</span></div>

    <div id="messages"></div>

    <form id="form" enctype="multipart/form-data">
        <div id="input-area">
            <input id="input" type="text" placeholder="Ketik pesan..." autocomplete="off">
            <input type="file" id="image" accept="image/*">
            <button id="sendBtn" type="submit">Kirim</button>
        </div>
        <button id="clearBtn" type="button">Hapus Chat</button>
    </form>

</div>

<script>
    const userId = localStorage.getItem("userId") || crypto.randomUUID();
    localStorage.setItem("userId", userId);
    
    const messagesDiv = document.getElementById("messages");

    // ================== LOAD CHAT ===================
    async function loadMessages() {
        const res = await fetch("/messages?userId=" + userId);
        const data = await res.json();

        messagesDiv.innerHTML = "";
        data.forEach(m => addMessage(m));
    }

    function addMessage(msg) {
        const div = document.createElement("div");
        div.className = "msg" + (msg.userId === userId ? " me" : "");
        div.innerHTML = `
            <b>${msg.name}</b> (${msg.time})<br>
            ${msg.text ? msg.text : ""}
            ${msg.image ? `<br><img src="${msg.image}" style="max-width:200px;border-radius:10px;">` : ""}
        `;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // ================== SEND MESSAGE ===================
    document.getElementById("form").onsubmit = async (e) => {
        e.preventDefault();
        const text = document.getElementById("input").value;
        const file = document.getElementById("image").files[0];

        if (!text && !file) return;

        const fd = new FormData();
        fd.append("text", text);
        fd.append("userId", userId);
        fd.append("name", "Pengguna");
        if (file) fd.append("image", file);

        await fetch("/send", { method:"POST", body:fd });

        document.getElementById("input").value = "";
        document.getElementById("image").value = "";

        loadMessages();
    };

    // ================== CLEAR CHAT ===================
    document.getElementById("clearBtn").onclick = async () => {
        await fetch("/clear", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ userId })
        });
        messagesDiv.innerHTML = "";
    };

    // ================== ONLINE USERS ===================
    setInterval(async () => {
        await fetch("/heartbeat", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ userId, name:"Pengguna" })
        });

        const r = await fetch("/online");
        const list = await r.json();
        document.getElementById("onlineCount").textContent = list.length;
    }, 3000);

    // ================== AUTO REFRESH ===================
    setInterval(loadMessages, 2000);

    loadMessages();
</script>

</body>
</html>
