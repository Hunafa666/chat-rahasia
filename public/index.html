<div id="chatContainer">
    <div id="chatBox"></div>
    <div id="inputBox">
        <input id="msgInput" type="text" placeholder="Ketik pesan...">
        <input id="imgInput" type="file" accept="image/*">
        <button id="btnSend">Kirim</button>
    </div>
</div>

<!-- ONLINE USERS -->
<div id="onlineBox" style="position:absolute;right:10px;top:80px;width:150px;background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.2);">
    <h4>Online</h4>
    <ul id="onlineList"></ul>
</div>

<script>
let userId = sessionStorage.getItem("userId");
if(!userId){ userId="user_"+Math.floor(Math.random()*10000); sessionStorage.setItem("userId", userId); }

let myName = sessionStorage.getItem("myName");
if(!myName){ myName = prompt("Masukkan nama kamu","Anon"); sessionStorage.setItem("myName", myName); }

const chatBox = document.getElementById("chatBox");
const msgInput = document.getElementById("msgInput");
const imgInput = document.getElementById("imgInput");

// ===== LOAD MESSAGES =====
async function loadMessages(){
    try{
        const res = await fetch("/messages");
        const data = await res.json();
        chatBox.innerHTML = "";

        let imagesToLoad = 0;

        data.forEach(msg=>{
            const div = document.createElement("div");
            div.className="msg "+(msg.userId===userId?"self":"other");
            div.innerHTML = `<div class="name">${msg.name}:</div>`;
            if(msg.text) div.innerHTML += `<div class="text">${msg.text}</div>`;
            if(msg.image){
                const img = document.createElement("img");
                img.src = msg.image;
                imagesToLoad++;
                img.onload = () => {
                    imagesToLoad--;
                    if(imagesToLoad===0){
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                }
                div.appendChild(img);
            }
            div.innerHTML += `<div class="time">${msg.time}</div>`;
            chatBox.appendChild(div);
        });

        if(imagesToLoad===0){
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    }catch(err){ console.error(err); }
}

// ===== KIRIM =====
async function kirim(){
    const text = msgInput.value.trim();
    const imgFile = imgInput.files[0];
    if(!text && !imgFile) return;

    const formData = new FormData();
    formData.append("text", text);
    formData.append("name", myName);
    formData.append("userId", userId);
    if(imgFile) formData.append("image", imgFile);

    try{
        await fetch("/send", { method:"POST", body:formData });
    }catch(err){ console.error(err); }

    msgInput.value=""; imgInput.value="";
    msgInput.focus();
    loadMessages();
}

// ===== ONLINE USERS =====
async function updateOnline() {
    await fetch("/heartbeat", {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ userId, name: myName })
    });
    const res = await fetch("/online");
    const online = await res.json();
    const ul = document.getElementById("onlineList");
    ul.innerHTML = "";
    online.forEach(name=>{
        const li = document.createElement("li");
        li.textContent = name;
        ul.appendChild(li);
    });
}

document.getElementById("btnSend").addEventListener("click", kirim);
msgInput.addEventListener("keypress", e=>{ if(e.key==="Enter"){ e.preventDefault(); kirim(); } });

// ===== AUTO REFRESH =====
setInterval(loadMessages,1000);
setInterval(updateOnline,5000);

loadMessages();
updateOnline();
</script>
