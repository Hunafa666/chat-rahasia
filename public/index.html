<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CHAT RAHASIA</title>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand&display=swap" rel="stylesheet">
<style>
body{margin:0;padding:0;font-family:'Quicksand',sans-serif;background:#f0e6dc;}
header{max-width:600px;margin:20px auto;padding:20px 0;font-family:'ARIAL', bold;font-size:2rem;color:#000000;text-align:center;border-radius:20px;background:linear-gradient(90deg,#ffffff);box-shadow:0 0 0 3px #4B2E2E,0 4px 10px rgba(0,0,0,0.3);}
#chatContainer{max-width:600px;margin:20px auto;height:70vh;display:flex;flex-direction:column;background: rgba(165,123,91,0.85);border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,0.3);padding:15px;}
#chatBox{flex:1;overflow-y:auto;padding-right:5px;scroll-behavior:smooth;}
#inputBox{display:flex;gap:5px;margin-top:10px;}
#inputBox input[type=text]{flex:1;padding:10px;border-radius:20px;border:none;font-size:16px;}
#inputBox input[type=file]{border:none;width:35%;padding:5px;}
#inputBox button{padding:10px 20px;border:none;border-radius:20px;background:#4caf50;color:#fff;cursor:pointer;font-size:16px;}
.msg{max-width:70%;padding:10px 15px;border-radius:25px;margin:5px 0;box-shadow:0 1px 3px rgba(0,0,0,0.2);word-wrap:break-word;overflow-wrap:break-word;white-space:pre-wrap;transition: all 0.2s ease;}
.msg.self{align-self:flex-end;background:#4caf50;color:white;}
.msg.other{align-self:flex-start;background:#ffffff;color:black;}
.msg .name{font-weight:bold;margin-bottom:3px;}
.msg .time{font-size:12px;color:#555;text-align:right;margin-top:3px;}
.msg img{max-width:100%;border-radius:15px;margin-top:5px;display:block;}
@media screen and (max-width:599px){
header,#chatContainer{max-width:95%;margin:15px auto;padding:15px;border-radius:15px;}
#chatBox{padding-right:0;}
#inputBox input[type=text]{font-size:14px;padding:8px;}
#inputBox button{font-size:14px;padding:8px 12px;}
.msg{max-width:80%;font-size:14px;padding:8px 10px;}
.msg img{max-width:90%;}
header{font-size:1.8rem;}
}
</style>
</head>
<body>

<header>CHAT RAHASIA</header>

<div id="chatContainer">
    <div id="chatBox"></div>
    <div id="inputBox">
        <input id="msgInput" type="text" placeholder="Ketik pesan...">
        <input id="imgInput" type="file" accept="image/*">
        <button id="btnSend">Kirim</button>
    </div>
</div>

<script>
let userId = sessionStorage.getItem("userId");
if(!userId){ userId="user_"+Math.floor(Math.random()*10000); sessionStorage.setItem("userId", userId); }

let myName = sessionStorage.getItem("myName");
if(!myName){ myName = prompt("Masukkan nama kamu","Anon"); sessionStorage.setItem("myName", myName); }

const chatBox = document.getElementById("chatBox");
const msgInput = document.getElementById("msgInput");
const imgInput = document.getElementById("imgInput");

async function loadMessages(){
    try{
        const res = await fetch("/messages");
        const data = await res.json();
        chatBox.innerHTML = "";

        let imagesToLoad = 0;

        data.forEach(msg=>{
            const div = document.createElement("div");
            div.className="msg "+(msg.userId===userId?"self":"other");
            div.innerHTML = `<div class="name">${msg.name}:</div>`;
            if(msg.text) div.innerHTML += `<div class="text">${msg.text}</div>`;
            if(msg.image){
                const img = document.createElement("img");
                img.src = msg.image;
                imagesToLoad++;
                img.onload = () => {
                    imagesToLoad--;
                    if(imagesToLoad===0){
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                }
                div.appendChild(img);
            }
            div.innerHTML += `<div class="time">${msg.time}</div>`;
            chatBox.appendChild(div);
        });

        if(imagesToLoad===0){
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    }catch(err){ console.error(err); }
}

async function kirim(){
    const text = msgInput.value.trim();
    const imgFile = imgInput.files[0];
    if(!text && !imgFile) return;

    const formData = new FormData();
    formData.append("text", text);
    formData.append("name", myName);
    formData.append("userId", userId);
    if(imgFile) formData.append("image", imgFile);

    try{
        await fetch("/send", { method:"POST", body:formData });
    }catch(err){ console.error(err); }

    msgInput.value=""; imgInput.value="";
    msgInput.focus();
    loadMessages();
}

document.getElementById("btnSend").addEventListener("click", kirim);
msgInput.addEventListener("keypress", e=>{ if(e.key==="Enter"){ e.preventDefault(); kirim(); } });

// Auto refresh tiap 1 detik
setInterval(loadMessages,1000);
loadMessages();
</script>

</body>
</html>
